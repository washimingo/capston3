<!-- =================== ALERTA ELIMINAR FACTURA =================== -->
<ion-alert
  [isOpen]="mostrarAlertaEliminar"
  header="¿Eliminar factura?"
  message="¿Seguro que deseas eliminar esta factura? Esta acción no se puede deshacer."
  [buttons]="alertEliminarButtons"
  (didDismiss)="mostrarAlertaEliminar = false">
</ion-alert>

<!-- =================== DRAWER EDICIÓN FACTURA =================== -->
<div class="drawer-carga-factura" *ngIf="abrirDrawerEditar">
  <div class="drawer-overlay" (click)="cancelarEdicion()"></div>
  <aside class="drawer-panel drawer-panel-form">
    <ion-header class="drawer-header">
      <ion-toolbar>
        <ion-title>Editar factura</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cancelarEdicion()">Cerrar</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="drawer-content modal-detalle-content">
      <form (submit)="guardarEdicion(); $event.preventDefault();" style="padding: 16px;">
        <!-- Campos de edición de factura -->
        <ion-item lines="none" class="file-upload-item">
          <ion-label position="stacked">Archivo (PDF, XML, imagen):</ion-label>
          <div class="file-upload-wrapper">
            <input type="file" (change)="onFileSelected($event)" accept=".pdf,.xml,image/*" />
            <span class="file-upload-label">Seleccionar archivo</span>
            <span class="file-upload-filename" *ngIf="archivoSeleccionado">{{ archivoSeleccionado.name }}</span>
            <span class="file-upload-filename" *ngIf="!archivoSeleccionado && editandoFactura?.archivo">{{ editandoFactura?.archivo }}</span>
          </div>
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Folio / N° Factura</ion-label>
          <input type="text" [(ngModel)]="facturaEditada.folio" name="folioEdit" required />
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Proveedor</ion-label>
          <input type="text" [(ngModel)]="facturaEditada.proveedor" name="proveedorEdit" required />
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Tipo</ion-label>
          <select [(ngModel)]="facturaEditada.tipo" name="tipoEdit" required style="width: 100%;">
            <option value="">Seleccione tipo</option>
            <option value="Compra">Compra</option>
            <option value="Servicio">Servicio</option>
            <option value="Honorarios">Honorarios</option>
            <option value="Otro">Otro</option>
          </select>
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Responsable</ion-label>
          <input type="text" [(ngModel)]="facturaEditada.responsable" name="responsableEdit" required />
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Monto</ion-label>
          <input type="number" [(ngModel)]="facturaEditada.monto" name="montoEdit" required />
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Fecha de recepción</ion-label>
          <input type="date" [(ngModel)]="facturaEditada.fechaRecepcion" name="fechaRecepcionEdit" required />
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Comentario</ion-label>
          <input type="text" [(ngModel)]="facturaEditada.comentario" name="comentarioEdit" />
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Mensaje de alerta</ion-label>
          <input type="text" [(ngModel)]="facturaEditada.mensajeAlerta" name="mensajeAlertaEdit" />
        </ion-item>
        <ion-button expand="block" type="submit" color="granite" style="margin-top: 12px;">Guardar cambios</ion-button>
        <ion-text color="danger" *ngIf="errorCarga">{{ errorCarga }}</ion-text>
        <ion-text color="success" *ngIf="exitoCarga">{{ exitoCarga }}</ion-text>
      </form>
    </ion-content>
  </aside>
</div>

<!-- =================== HEADER Y TOOLBAR =================== -->
<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Facturación</ion-title>
    <ion-buttons slot="end">
      <ion-button color="secondary" fill="clear" (click)="mostrarFacturasGuardadas()" class="btn-console">
        <ion-icon name="list-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>


<!-- =================== CONTENIDO PRINCIPAL =================== -->
<ion-content class="invoices-content">
  <ion-refresher slot="fixed" (ionRefresh)="refrescar($event)">
    <ion-refresher-content
      pullingIcon="arrow-dropdown"
      refreshingSpinner="crescent"
      pullingText="Desliza para refrescar"
      refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>
  <!-- ====== FILTROS Y BUSQUEDA ====== -->
  <div class="filtros-chips filtros-chips-bonitos">
    <form class="form-filtros" (ngSubmit)="$event.preventDefault()">
      <div class="chips-filtros-wrapper" style="margin-top: 8px;">
        <!-- Chips de categorías -->
        <ion-chip *ngFor="let cat of categoriasResumen"
          [color]="categoriaSeleccionada === cat.estado ? cat.color : 'medium'"
          [outline]="categoriaSeleccionada !== cat.estado" (click)="seleccionarCategoria(cat.estado)" class="chip-filtro">
          <ion-icon [name]="getIconoEstado(cat.estado)" slot="start"></ion-icon>
          {{ cat.nombre }}
          <ion-badge [color]="cat.color" class="chip-badge">{{ getResumenCount(cat.estado) }}</ion-badge>
        </ion-chip>
        <ion-chip *ngIf="categoriaSeleccionada" color="light" outline (click)="categoriaSeleccionada = null"
          class="chip-limpiar-filtro">
          Limpiar filtro
          <ion-icon name="close-outline" slot="end"></ion-icon>
        </ion-chip>
        <!-- Campo de búsqueda -->
        <ion-row>
          <ion-col size="12" size-md="9">
            <ion-item lines="none" class="filtro-busqueda-item minimal-granate">
              <ion-icon name="search-outline" slot="start" class="icono-busqueda"></ion-icon>
              <ion-input [(ngModel)]="filtroBusqueda" name="filtroBusqueda" debounce="300" placeholder="Buscar por {{ campoBusqueda }}" (ionInput)="onBuscarFactura()" />
              <ng-container *ngIf="buscandoFacturas">
                <ion-spinner name="dots" color="granite" class="busqueda-spinner-inline"></ion-spinner>
              </ng-container>
              <ion-button *ngIf="filtroBusqueda" fill="clear" size="small" class="btn-limpiar-busqueda" (click)="filtroBusqueda=''; onBuscarFactura();" slot="end" title="Limpiar búsqueda">
                <ion-icon name="close-circle" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-item>
            <!-- Sugerencias de autocompletado -->
            <div *ngIf="sugerenciasBusqueda.length > 0 && filtroBusqueda && !buscandoFacturas" class="sugerencias-autocompletado">
              <ion-list>
                <ion-item button *ngFor="let sugerencia of sugerenciasBusqueda" (click)="seleccionarSugerencia(sugerencia)">
                  <ion-label>{{ sugerencia }}</ion-label>
                </ion-item>
              </ion-list>
            </div>
          </ion-col>
        </ion-row>
      </div>
    </form>
    <!-- Botón para abrir modal de carga de factura -->
    <ion-button color="granite" class="btn-agregar-factura-filtros" (click)="abrirModalCarga = true" style="margin-top: 8px;">
      <ion-icon name="add-circle-outline" slot="start"></ion-icon>
      Subir Factura
    </ion-button>
  </div>

  <!-- ====== DRAWER CARGA FACTURA ====== -->
  <div class="drawer-carga-factura" *ngIf="abrirModalCarga">
    <div class="drawer-overlay" (click)="cerrarModalCarga()"></div>
    <aside class="drawer-panel drawer-panel-form">
      <ion-header class="drawer-header">
        <ion-toolbar>
          <ion-title>Cargar factura</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModalCarga()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="drawer-content modal-detalle-content">
        <form (submit)="onSubmitFactura($event)" style="padding: 16px;">
          <!-- Campos de carga de factura -->
          <ion-item lines="none" class="file-upload-item">
            <ion-label position="stacked">Archivo (PDF, XML, imagen):</ion-label>
            <div class="file-upload-wrapper">
              <input type="file" (change)="onFileSelected($event)" accept=".pdf,.xml,.xlsx,image/*" required />
              <span class="file-upload-label">Seleccionar archivo</span>
              <span class="file-upload-filename" *ngIf="archivoSeleccionado">{{ archivoSeleccionado.name }}</span>
            </div>
          </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Folio / N° Factura</ion-label>
            <input type="text" [(ngModel)]="nuevaFactura.folio" name="folio" required />
          </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Proveedor</ion-label>
            <input type="text" [(ngModel)]="nuevaFactura.proveedor" name="proveedor" required />
          </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Tipo</ion-label>
            <select [(ngModel)]="nuevaFactura.tipo" name="tipo" required style="width: 100%;">
              <option value="">Seleccione tipo</option>
              <option value="Compra">Compra</option>
              <option value="Servicio">Servicio</option>
              <option value="Honorarios">Honorarios</option>
              <option value="Otro">Otro</option>
            </select>
          </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Responsable</ion-label>
            <input type="text" [(ngModel)]="nuevaFactura.responsable" name="responsable" required />
          </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Monto</ion-label>
            <input type="number" [(ngModel)]="nuevaFactura.monto" name="monto" required />
          </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Fecha de recepción</ion-label>
            <input type="date" [(ngModel)]="nuevaFactura.fechaRecepcion" name="fechaRecepcion" required />
          </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Comentario</ion-label>
            <input type="text" [(ngModel)]="nuevaFactura.comentario" name="comentario" />
          </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Mensaje de alerta</ion-label>
            <input type="text" [(ngModel)]="nuevaFactura.mensajeAlerta" name="mensajeAlerta" />
          </ion-item>
          <ion-button expand="block" type="submit" color="granite" style="margin-top: 12px;">Subir Factura</ion-button>
          <ion-text color="danger" *ngIf="errorCarga">{{ errorCarga }}</ion-text>
          <ion-text color="success" *ngIf="exitoCarga">{{ exitoCarga }}</ion-text>
        </form>
      </ion-content>
    </aside>
  </div>

  <!-- ====== TABLA DE FACTURAS ====== -->
  <div class="tabla-facturas-wrapper">
    <table class="tabla-facturas">
      <thead>
        <tr>
          <th>Estado</th>
          <th>Folio</th>
          <th>Proveedor</th>
          <th>Tipo</th>
          <th>Responsable</th>
          <th>Monto</th>
          <th>Fecha recepción</th>
          <th>Comentario</th>
          <th>Mensaje alerta</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let factura of facturasFiltradas">
          <td>
            <ion-icon [name]="getIconoEstado(factura.estado)" [color]="getColorEstado(factura.estado)"
              class="tabla-estado-icon"></ion-icon>
            <ion-badge [color]="getColorEstado(factura.estado)" class="tabla-estado-badge">{{ factura.estado }}</ion-badge>
          </td>
          <td>{{ factura.folio }}</td>
          <td>{{ factura.proveedor }}</td>
          <td>{{ factura.tipo }}</td>
          <td>{{ factura.responsable }}</td>
          <td>${{ factura.monto | number:'1.2-2' }}</td>
          <td>{{ factura.fechaRecepcion | date:'dd/MM/yyyy' }}</td>
          <td>{{ factura.comentario }}</td>
          <td>{{ factura.mensajeAlerta }}</td>
          <td>
            <ion-button size="small" fill="clear" color="primary" (click)="verFactura(factura)" title="Ver detalles">
              <ion-icon name="alert-circle-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button size="small" fill="clear" color="success" (click)="editarFactura(factura)" title="Editar">
              <ion-icon name="create-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button size="small" fill="clear" color="danger" (click)="eliminarFactura(factura)" title="Eliminar">
              <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </td>
        </tr>
        <tr *ngIf="facturasFiltradas.length === 0">
          <td colspan="6" class="tabla-vacia">
            <ion-icon name="document-text-outline" size="large" color="medium"></ion-icon>
            <div>No hay facturas para mostrar.</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ====== DRAWER DETALLE FACTURA ====== -->
  <div class="drawer-detalle-factura" *ngIf="facturaSeleccionada">
    <div class="drawer-overlay" (click)="cerrarDetalles()"></div>
    <aside class="drawer-panel drawer-panel-form">
      <ion-header class="drawer-header">
        <ion-toolbar>
          <ion-title>Detalle de Factura</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarDetalles()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="drawer-content modal-detalle-content">
        <ion-card class="detalle-factura-card">
          <ion-card-header class="detalle-factura-header">
            <div class="detalle-factura-top">
              <ion-icon [name]="getIconoEstado(facturaSeleccionada.estado)"
                [color]="getColorEstado(facturaSeleccionada.estado)" class="detalle-estado-icon"></ion-icon>
              <div>
                <ion-badge [color]="getColorEstado(facturaSeleccionada.estado)" class="detalle-estado-badge">{{ facturaSeleccionada.estado }}</ion-badge>
                <div class="detalle-factura-id">Factura #{{ facturaSeleccionada.folio }}</div>
              </div>
            </div>
            <ion-card-title class="detalle-factura-cliente">{{ facturaSeleccionada.proveedor }}</ion-card-title>
            <div class="detalle-factura-monto">${{ facturaSeleccionada.monto | number:'1.2-2' }}</div>
          </ion-card-header>
          <ion-card-content>
            <div class="detalle-factura-info">
              <div><ion-icon name="calendar-outline"></ion-icon> <b>Fecha recepción:</b> {{ facturaSeleccionada.fechaRecepcion | date:'dd/MM/yyyy' }}</div>
              <div><ion-icon name="person-outline"></ion-icon> <b>Responsable:</b> {{ facturaSeleccionada.responsable }}</div>
              <div><ion-icon name="pricetag-outline"></ion-icon> <b>Tipo:</b> {{ facturaSeleccionada.tipo }}</div>
              <div><ion-icon name="chatbubble-ellipses-outline"></ion-icon> <b>Comentario:</b> {{ facturaSeleccionada.comentario }}</div>
              <div><ion-icon name="alert-outline"></ion-icon> <b>Mensaje de alerta:</b> {{ facturaSeleccionada.mensajeAlerta }}</div>
              <ng-container *ngIf="facturaSeleccionada as f">
                <ng-container *ngIf="getDiasRestantes(f) as diasRestantes">
                  <div *ngIf="diasRestantes !== null">
                    <ng-container [ngSwitch]="true">
                      <!-- Vencida -->
                      <div *ngSwitchCase="diasRestantes <= 0">
                        <ion-icon name="warning-outline" color="danger"></ion-icon>
                        <b class="color-danger">¡Factura vencida!</b>
                        <span class="color-medium">El plazo de 8 días ha expirado.</span>
                      </div>
                      <!-- Por vencer (2 días o menos) -->
                      <div *ngSwitchCase="diasRestantes <= 2 && diasRestantes > 0">
                        <ion-icon name="alert-circle-outline" color="warning"></ion-icon>
                        <b class="color-warning">¡Atención!</b>
                        <span class="color-warning">Solo quedan {{ diasRestantes }} día{{ diasRestantes === 1 ? '' : 's' }} para que venza.</span>
                        <div class="mensaje-motivacional">¡Aún estás a tiempo de gestionarla!</div>
                      </div>
                      <!-- Con tiempo (más de 2 días) -->
                      <div *ngSwitchDefault>
                        <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                        <b class="color-success">¡Factura al día!</b>
                        <span class="color-success">Quedan {{ diasRestantes }} días para el vencimiento.</span>
                        <div class="mensaje-motivacional">¡Sigue así, tu gestión es excelente!</div>
                      </div>
                    </ng-container>
                  </div>
                </ng-container>
              </ng-container>
            </div>
            <div *ngIf="facturaSeleccionada.archivo" class="detalle-factura-archivo">
              <ion-label class="archivo-label"><ion-icon name="attach-outline"></ion-icon> Archivo adjunto:</ion-label>
              <div class="archivo-preview">
                <ng-container [ngSwitch]="((facturaSeleccionada.archivo && facturaSeleccionada.archivo.split('.').pop()) || '').toLowerCase()">
                  <ng-container *ngSwitchCase="'pdf'">
                    <iframe [src]="getFacturaFileUrl(facturaSeleccionada)" width="100%" height="300px" style="border: none;"></iframe>
                    <ion-button size="small" color="primary" (click)="descargarArchivo(facturaSeleccionada)">
                      <ion-icon name="download-outline" slot="start"></ion-icon> Descargar
                    </ion-button>
                  </ng-container>
                  <ng-container *ngSwitchCase="'jpg'">
                    <img [src]="getFacturaFileUrl(facturaSeleccionada)" alt="Factura adjunta" style="max-width:100%; max-height:300px;" />
                    <ion-button size="small" color="primary" (click)="descargarArchivo(facturaSeleccionada)">
                      <ion-icon name="download-outline" slot="start"></ion-icon> Descargar
                    </ion-button>
                  </ng-container>
                  <ng-container *ngSwitchCase="'jpeg'">
                    <img [src]="getFacturaFileUrl(facturaSeleccionada)" alt="Factura adjunta" style="max-width:100%; max-height:300px;" />
                    <ion-button size="small" color="primary" (click)="descargarArchivo(facturaSeleccionada)">
                      <ion-icon name="download-outline" slot="start"></ion-icon> Descargar
                    </ion-button>
                  </ng-container>
                  <ng-container *ngSwitchCase="'png'">
                    <img [src]="getFacturaFileUrl(facturaSeleccionada)" alt="Factura adjunta" style="max-width:100%; max-height:300px;" />
                    <ion-button size="small" color="primary" (click)="descargarArchivo(facturaSeleccionada)">
                      <ion-icon name="download-outline" slot="start"></ion-icon> Descargar
                    </ion-button>
                  </ng-container>
                  <ng-container *ngSwitchCase="'xml'">
                    <ion-text color="medium">Archivo XML: {{ facturaSeleccionada.archivo }}</ion-text>
                  </ng-container>
                  <ng-container *ngSwitchCase="'xlsx'">
                    <ion-text color="medium">Archivo Excel: {{ facturaSeleccionada.archivo }}</ion-text>
                    <ion-button size="small" color="primary" (click)="descargarArchivo(facturaSeleccionada)">
                      <ion-icon name="download-outline" slot="start"></ion-icon> Descargar
                    </ion-button>
                    <div *ngIf="excelPreviewError" class="excel-preview-error">{{ excelPreviewError }}</div>
                    <div *ngIf="excelPreviewData && !excelPreviewError" class="excel-preview-table-wrapper">
                      <table class="excel-preview-table">
                        <tr *ngFor="let row of excelPreviewData">
                          <td *ngFor="let cell of row">{{ cell }}</td>
                        </tr>
                      </table>
                    </div>
                  </ng-container>
                  <ng-container *ngSwitchDefault>
                    <ion-text color="medium">Archivo: {{ facturaSeleccionada.archivo }}</ion-text>
                    <ion-button size="small" color="primary" (click)="descargarArchivo(facturaSeleccionada)">
                      <ion-icon name="download-outline" slot="start"></ion-icon> Descargar
                    </ion-button>
                  </ng-container>
                </ng-container>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
        <ion-card class="detalle-factura-bitacora">
          <ion-card-header>
            <ion-card-title>Bitácora / Auditoría</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let log of facturaSeleccionada.bitacora">
                <ion-label>
                  <b>{{ log.usuario }}</b> - {{ log.accion }}<br>
                  <small>{{ log.fecha | date:'short' }}</small>
                </ion-label>
              </ion-item>
              <ion-item *ngIf="!facturaSeleccionada.bitacora || facturaSeleccionada.bitacora.length === 0">
                <ion-label color="medium">Sin movimientos registrados.</ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </ion-content>
    </aside>
  </div>
</ion-content>