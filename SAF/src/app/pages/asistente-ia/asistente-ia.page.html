<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="abrirMenu()">
        <ion-icon name="menu-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>ü§ñ Asistente IA</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Sugerencias IA -->
  <div class="bg-blue-50 rounded-xl p-4 mb-6 border border-blue-200">
    <h2 class="text-lg font-semibold text-blue-700 mb-2 flex items-center">
      <ion-icon name="bulb-outline" class="mr-2"></ion-icon>
      Sugerencias r√°pidas
    </h2>
    <div class="flex flex-wrap gap-2">
      <ion-chip *ngFor="let sugerencia of sugerenciasIA" (click)="preguntaUsuario = sugerencia; enviarMensajeChat()" color="primary">
        {{sugerencia}}
      </ion-chip>
    </div>
  </div>

  <!-- Chatbot IA -->
  <div class="bg-white rounded-xl shadow-md border border-gray-200 mb-6 p-4">
    <h2 class="text-lg font-semibold text-gray-900 mb-2 flex items-center">
      <ion-icon name="chatbubbles-outline" class="mr-2"></ion-icon>
      Chat IA
    </h2>
    <div class="chat-mensajes mb-3 max-h-48 overflow-y-auto">
      <div *ngFor="let msg of mensajesChat">
        <div [ngClass]="{'text-right': msg.usuario === 'T√∫', 'text-left': msg.usuario === 'IA'}">
          <span class="font-bold" [ngClass]="{'text-blue-600': msg.usuario === 'IA', 'text-gray-800': msg.usuario === 'T√∫'}">{{msg.usuario}}:</span>
          <span class="ml-2">{{msg.mensaje}}</span>
        </div>
      </div>
    </div>
    <form (ngSubmit)="enviarMensajeChat()" class="flex gap-2">
      <ion-input [(ngModel)]="preguntaUsuario" name="preguntaUsuario" placeholder="Escribe tu pregunta..." class="flex-1"></ion-input>
      <ion-button type="submit" color="primary">Enviar</ion-button>
    </form>
  </div>
  
  <!-- Header con estad√≠sticas -->
  <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl p-6 mb-6 border border-blue-200">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center space-x-3">
        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
          <ion-icon name="sparkles-outline" class="text-white text-2xl"></ion-icon>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Asistente IA</h1>
          <p class="text-gray-600">Procesamiento inteligente de facturas CSV</p>
        </div>
      </div>
      <ion-button (click)="mostrarAnalisisIA()" fill="outline" color="primary">
        <ion-icon name="analytics-outline" slot="start"></ion-icon>
        An√°lisis
      </ion-button>
    </div>

    <!-- Estad√≠sticas r√°pidas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="bg-white rounded-lg p-3 text-center">
        <div class="text-2xl font-bold text-blue-600">{{estadisticasIA.facturasProcesadas}}</div>
        <div class="text-sm text-gray-600">Procesadas</div>
      </div>
      <div class="bg-white rounded-lg p-3 text-center">
        <div class="text-2xl font-bold text-green-600">{{facturasIA.length}}</div>
        <div class="text-sm text-gray-600">Guardadas</div>
      </div>
      <div class="bg-white rounded-lg p-3 text-center">
        <div class="text-2xl font-bold text-yellow-600">{{estadisticasIA.duplicadosDetectados}}</div>
        <div class="text-sm text-gray-600">Duplicados</div>
      </div>
      <div class="bg-white rounded-lg p-3 text-center">
        <div class="text-2xl font-bold text-purple-600">{{estadisticasIA.categorizacionesAutomaticas}}</div>
        <div class="text-sm text-gray-600">Categorizadas</div>
      </div>
    </div>
  </div>

  <!-- Secci√≥n de carga de CSV -->
  <div class="bg-white rounded-xl shadow-md border border-gray-200 mb-6">
    <div class="p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
        <ion-icon name="cloud-upload-outline" class="text-blue-500 mr-2"></ion-icon>
        Procesar Archivo CSV
      </h2>
      
      <div class="space-y-4">
        <!-- Input de archivo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Seleccionar archivo CSV
          </label>
          <input 
            type="file" 
            (change)="manejarArchivoCSV($event)" 
            accept=".csv"
            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300 rounded-lg cursor-pointer">
        </div>

        <!-- Bot√≥n de procesamiento -->
        <div class="flex justify-end">
          <ion-button 
            (click)="procesarCSVConIA()"
            [disabled]="!archivoCsv || procesandoCSV"
            color="primary"
            fill="solid">
            <ion-icon name="cog-outline" slot="start" *ngIf="!procesandoCSV"></ion-icon>
            <ion-icon name="refresh-outline" slot="start" *ngIf="procesandoCSV" class="animate-spin"></ion-icon>
            <span *ngIf="!procesandoCSV">Procesar con IA</span>
            <span *ngIf="procesandoCSV">Procesando...</span>
          </ion-button>
        </div>

        <!-- Indicador de carga -->
        <div *ngIf="procesandoCSV" class="text-center py-4">
          <ion-spinner name="circles" color="primary"></ion-spinner>
          <p class="text-sm text-gray-600 mt-2">ü§ñ IA analizando datos CSV...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista previa de datos procesados -->
  <div *ngIf="mostrandoPreview" class="bg-white rounded-xl shadow-md border border-green-200 mb-6">
    <div class="p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
        <ion-icon name="checkmark-circle-outline" class="text-green-500 mr-2"></ion-icon>
        Vista Previa - Datos Procesados
      </h2>

      <!-- Resumen del procesamiento -->
      <div class="bg-green-50 rounded-lg p-4 mb-4">
        <p class="text-green-800">
          <strong>{{datosCSVProcesados.length}}</strong> facturas detectadas ‚Ä¢ 
          <strong>{{getFacturasNuevas()}}</strong> nuevas ‚Ä¢ 
          <strong>{{getFacturasDuplicadas()}}</strong> duplicados
        </p>
      </div>

      <!-- Tabla de vista previa -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Folio</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proveedor</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categor√≠a</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Confianza</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let factura of datosCSVProcesados" 
                [class.bg-green-50]="factura.esNueva"
                [class.bg-red-50]="!factura.esNueva">
              <td class="px-4 py-3 whitespace-nowrap">
                <span *ngIf="factura.esNueva" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  ‚úì Nueva
                </span>
                <span *ngIf="!factura.esNueva" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  ‚ö† Duplicado
                </span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">{{factura.folio}}</td>
              <td class="px-4 py-3 text-sm text-gray-900">{{factura.razonSocial}}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${{factura.montoTotal | number}}</td>
              <td class="px-4 py-3 text-sm text-gray-900">{{factura.categoria?.categoria}}</td>
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full" [style.width.%]="factura.confianza * 100"></div>
                  </div>
                  <span class="ml-2 text-sm text-gray-600">{{(factura.confianza * 100).toFixed(0)}}%</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="flex justify-end space-x-3 mt-6">
        <ion-button fill="outline" color="medium" (click)="mostrandoPreview = false">
          Cancelar
        </ion-button>
        <ion-button 
          (click)="confirmarFacturasIA()"
          color="success"
          [disabled]="!hayFacturasNuevas()">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Guardar {{getFacturasNuevas()}} Facturas
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Lista de facturas guardadas en IA -->
  <div class="bg-white rounded-xl shadow-md border border-gray-200">
    <div class="p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
        <ion-icon name="list-outline" class="text-gray-600 mr-2"></ion-icon>
        Facturas Procesadas por IA ({{facturasIA.length}})
      </h2>

      <!-- Mensaje si no hay facturas -->
      <div *ngIf="facturasIA.length === 0" class="text-center py-8">
        <ion-icon name="document-outline" class="text-6xl text-gray-300 mb-4"></ion-icon>
        <p class="text-gray-500">No hay facturas procesadas por IA a√∫n</p>
        <p class="text-sm text-gray-400">Sube un archivo CSV para comenzar</p>
      </div>

      <!-- Lista de facturas -->
      <div *ngIf="facturasIA.length > 0" class="space-y-3">
        <div *ngFor="let factura of facturasIA" 
             class="border border-purple-200 rounded-lg p-4 bg-purple-50 hover:bg-purple-100 transition-colors">
          
          <!-- Header de la factura -->
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                <ion-icon name="sparkles-outline" class="text-white"></ion-icon>
              </div>
              <div>
                <h3 class="font-semibold text-gray-900">{{factura.folio}}</h3>
                <p class="text-sm text-gray-600">{{factura.proveedor}}</p>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <ion-badge [color]="getColorEstado(factura.estado)">
                <ion-icon [name]="getIconoEstado(factura.estado)" class="mr-1"></ion-icon>
                {{factura.estado}}
              </ion-badge>
            </div>
          </div>

          <!-- Detalles de la factura -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
            <div>
              <p class="text-xs font-medium text-gray-500 uppercase">Monto</p>
              <p class="text-sm font-semibold text-gray-900">${{factura.monto | number}}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500 uppercase">Fecha</p>
              <p class="text-sm text-gray-900">{{factura.fechaRecepcion | date:'dd/MM/yyyy'}}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500 uppercase">Responsable</p>
              <p class="text-sm text-gray-900">{{factura.responsable}}</p>
            </div>
            <div>
              <p class="text-xs font-medium text-gray-500 uppercase">Categor√≠a IA</p>
              <p class="text-sm text-purple-700 font-medium">{{factura.categoriaIA?.categoria || 'No clasificada'}}</p>
            </div>
          </div>

          <!-- Indicador de origen IA -->
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2 text-purple-600">
              <ion-icon name="robot-outline" class="text-sm"></ion-icon>
              <span class="text-xs font-medium">Procesada por IA</span>
              <span class="text-xs bg-purple-200 px-2 py-1 rounded">
                Confianza: {{factura.confianzaIA ? (factura.confianzaIA * 100).toFixed(0) : 'N/A'}}%
              </span>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="flex space-x-2">
              <ion-button 
                size="small" 
                fill="outline" 
                color="primary"
                (click)="moverAInvoices(factura)">
                <ion-icon name="arrow-forward-outline" slot="start"></ion-icon>
                Mover a Invoices
              </ion-button>
              <ion-button 
                size="small" 
                fill="outline" 
                color="danger"
                (click)="eliminarFacturaIA(factura)">
                <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</ion-content>
