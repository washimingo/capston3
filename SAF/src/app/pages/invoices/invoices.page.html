<!-- ====== DRAWER DE DETALLES DE FACTURA ====== -->
  <!-- Overlay del drawer - Transparente -->
  <div *ngIf="drawerVisible" 
       class="drawer-overlay fixed inset-0 z-50 transition-opacity duration-300"
       [class.opacity-100]="drawerVisible"
       (click)="cerrarDetalles()">
  </div>

  <!-- Drawer deslizante -->
  <div class="drawer-container fixed top-0 right-0 h-full w-full md:w-[500px] lg:w-[600px] xl:w-[700px] bg-white shadow-2xl transform transition-transform duration-300 ease-in-out z-50"
       [class.translate-x-0]="drawerVisible"
       [class.translate-x-full]="!drawerVisible">
    
    <!-- Bot칩n de cerrar -->
    <div class="absolute top-4 right-4 z-10">
      <button (click)="cerrarDetalles()" 
              class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-all duration-200 hover:scale-105 shadow-lg">
        <ion-icon name="close-outline" class="text-xl text-gray-600"></ion-icon>
      </button>
    </div>

    <!-- Contenido del drawer -->
    <div class="drawer-content flex-1 overflow-y-auto p-6 space-y-6" *ngIf="facturaSeleccionada">
      
      <!-- Estado destacado -->
      <div class="status-card bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Estado Actual</h3>
          <div class="w-2 h-2 rounded-full"
               [ngClass]="{
                 'bg-yellow-400': facturaSeleccionada.estado === 'pendiente',
                 'bg-green-400': facturaSeleccionada.estado === 'aceptada',
                 'bg-red-400': facturaSeleccionada.estado === 'rechazada',
                 'bg-gray-400': facturaSeleccionada.estado === 'vencida'
               }">
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <div class="status-icon w-12 h-12 rounded-full flex items-center justify-center"
               [ngClass]="{
                 'bg-yellow-100 text-yellow-600': facturaSeleccionada.estado === 'pendiente',
                 'bg-green-100 text-green-600': facturaSeleccionada.estado === 'aceptada',
                 'bg-red-100 text-red-600': facturaSeleccionada.estado === 'rechazada',
                 'bg-gray-100 text-gray-600': facturaSeleccionada.estado === 'vencida'
               }">
            <ion-icon [name]="getIconoEstado(facturaSeleccionada.estado)" class="text-xl"></ion-icon>
          </div>
          <div>
            <p class="text-lg font-semibold text-gray-900 capitalize">{{ facturaSeleccionada.estado }}</p>
            <p class="text-sm text-gray-600">
              D칤as restantes: 
              <span [ngClass]="{
                'text-red-600 font-semibold': getDiasRestantes(facturaSeleccionada)! <= 2,
                'text-orange-600 font-medium': getDiasRestantes(facturaSeleccionada)! > 2 && getDiasRestantes(facturaSeleccionada)! <= 5,
                'text-green-600': getDiasRestantes(facturaSeleccionada)! > 5,
                'text-gray-400': getDiasRestantes(facturaSeleccionada) === null
              }">
                {{ getDiasRestantes(facturaSeleccionada) !== null ? getDiasRestantes(facturaSeleccionada) + ' d칤as' : 'N/A' }}
              </span>
            </p>
          </div>
        </div>
      </div>

      <!-- Informaci칩n b치sica -->
      <div class="info-section">
        <h3 class="section-title text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <ion-icon name="document-text-outline" class="text-blue-600 mr-2"></ion-icon>
          Informaci칩n B치sica
        </h3>
        <div class="info-grid space-y-3">
          <div *ngFor="let header of csvHeaders" class="info-item flex justify-between py-3 border-b border-gray-100 hover:bg-gray-50 px-3 rounded-lg transition-colors">
            <span class="info-label font-medium text-gray-700 capitalize">{{ header }}:</span>
            <span class="info-value text-gray-900 font-medium text-right max-w-[60%] break-words">
              {{ getValorFactura(facturaSeleccionada, header) || 'N/A' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Fechas importantes -->
      <div class="dates-section">
        <h3 class="section-title text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <ion-icon name="calendar-outline" class="text-green-600 mr-2"></ion-icon>
          Fechas Importantes
        </h3>
        <div class="dates-grid grid grid-cols-1 gap-4">
          <!-- Fecha de emisi칩n -->
          <div class="date-card bg-blue-50 rounded-lg p-4 border border-blue-200">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <ion-icon name="calendar-number-outline" class="text-blue-600"></ion-icon>
              </div>
              <div>
                <p class="text-sm font-medium text-blue-700">Fecha de Emisi칩n</p>
                <p class="text-lg font-semibold text-blue-900">
                  {{ facturaSeleccionada.fecha || 'N/A' }}
                </p>
              </div>
            </div>
          </div>
          
          <!-- Fecha de vencimiento -->
          <div class="date-card bg-orange-50 rounded-lg p-4 border border-orange-200">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                <ion-icon name="time-outline" class="text-orange-600"></ion-icon>
              </div>
              <div>
                <p class="text-sm font-medium text-orange-700">Fecha de Vencimiento</p>
                <p class="text-lg font-semibold text-orange-900">
                  {{ calcularFechaVencimiento(facturaSeleccionada) || 'N/A' }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Progreso visual -->
      <div class="progress-section" *ngIf="getDiasRestantes(facturaSeleccionada) !== null">
        <h3 class="section-title text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <ion-icon name="speedometer-outline" class="text-purple-600 mr-2"></ion-icon>
          Progreso de Vencimiento
        </h3>
        <div class="progress-container bg-gray-50 rounded-xl p-4 border border-gray-200">
          <div class="flex justify-between items-center mb-3">
            <span class="text-sm font-medium text-gray-700">D칤as transcurridos</span>
            <span class="text-sm font-semibold" 
                  [ngClass]="{
                    'text-green-600': getDiasRestantes(facturaSeleccionada)! > 5,
                    'text-orange-600': getDiasRestantes(facturaSeleccionada)! > 2 && getDiasRestantes(facturaSeleccionada)! <= 5,
                    'text-red-600': getDiasRestantes(facturaSeleccionada)! <= 2
                  }">
              {{ 8 - getDiasRestantes(facturaSeleccionada)! }}/8 d칤as
            </span>
          </div>
          <div class="progress-bar-container w-full bg-gray-200 rounded-full h-3 overflow-hidden">
            <div class="progress-bar h-full rounded-full transition-all duration-500"
                 [style.width.%]="getProgressWidth(facturaSeleccionada)"
                 [ngClass]="{
                   'bg-gradient-to-r from-green-400 to-green-500': getDiasRestantes(facturaSeleccionada)! > 5,
                   'bg-gradient-to-r from-orange-400 to-orange-500': getDiasRestantes(facturaSeleccionada)! > 2 && getDiasRestantes(facturaSeleccionada)! <= 5,
                   'bg-gradient-to-r from-red-400 to-red-500': getDiasRestantes(facturaSeleccionada)! <= 2
                 }">
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<!-- =================== HEADER Y TOOLBAR =================== -->
<app-header title="Gesti칩n de Facturas" titleIcon="receipt-outline" shadowClass="shadow-sm" (buttonClick)="onHeaderButtonClick($event)"> </app-header>

<!-- =================== CONTENIDO PRINCIPAL =================== -->
<ion-content class="bg-gray-50">
  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="refrescar($event)">
    <ion-refresher-content 
      pullingIcon="arrow-dropdown" 
      refreshingSpinner="crescent"
      pullingText="Desliza para refrescar" 
      refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>

  <div class="min-h-screen">
    <div class="w-full px-4 lg:px-6 py-4 lg:py-6">

      <!-- ====== PANEL DE CONTROL SUPERIOR ====== -->
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 lg:gap-6 mb-4 lg:mb-6">
        
        <!-- Importar CSV - Optimizado -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:p-6">
          <h3 class="text-base lg:text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <ion-icon name="cloud-upload-outline" class="mr-2 text-blue-600 text-lg lg:text-xl"></ion-icon>
            Importar Facturas CSV
          </h3>
          <div class="space-y-3 lg:space-y-4">
            <div *ngIf="!archivoSeleccionado" class="border-2 border-dashed border-gray-300 rounded-lg p-3 lg:p-4 text-center hover:border-blue-400 transition-colors">
              <input type="file" 
                     (change)="onFileSelected($event)" 
                     accept=".csv,text/csv,application/csv,text/plain" 
                     class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
              <p class="text-xs text-gray-500 mt-2">Selecciona un archivo CSV para cargar m칰ltiples facturas</p>
            </div>
            <div *ngIf="archivoSeleccionado" class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
              <div class="flex items-center">
                <ion-icon name="document-outline" class="text-green-600 mr-2"></ion-icon>
                <span class="text-sm font-medium text-green-800">{{ getNombreArchivo() }}</span>
              </div>
              <button (click)="quitarArchivo()" 
                      class="text-red-600 hover:text-red-700 text-sm font-medium transition-colors">
                Quitar
              </button>
            </div>
            
            <!-- Mensajes de resultado -->
            <div *ngIf="exitoCarga" class="p-3 bg-green-50 border border-green-200 rounded-lg">
              <p class="text-sm text-green-800">{{ exitoCarga }}</p>
            </div>
            <div *ngIf="errorCarga" class="p-3 bg-red-50 border border-red-200 rounded-lg">
              <p class="text-sm text-red-800">{{ errorCarga }}</p>
            </div>
          </div>
        </div>

        <!-- Resumen de Estados - Optimizado -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 lg:p-6">
          <h3 class="text-base lg:text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <ion-icon name="analytics-outline" class="mr-2 text-blue-600 text-lg lg:text-xl"></ion-icon>
            Resumen por Estado
          </h3>
          <div class="grid grid-cols-2 gap-3 lg:gap-4">
            <div *ngFor="let categoria of categoriasResumen" 
                 class="summary-card"
                 [attr.data-status]="categoria.estado.toLowerCase()"
                 [class.active]="categoriaSeleccionada === categoria.estado"
                 (click)="seleccionarCategoria(categoria.estado)">
              
              <!-- Icono del estado -->
              <div class="summary-icon">
                <ion-icon [name]="getIconoEstado(categoria.estado)"></ion-icon>
              </div>
              
              <!-- N칰mero y label -->
              <div class="summary-content">
                <div class="summary-number">
                  {{ getResumenCount(categoria.estado) }}
                </div>
                <div class="summary-label">
                  {{ categoria.nombre }}
                </div>
              </div>
              
              <!-- Indicador de progreso -->
              <div class="summary-progress">
                <div class="progress-bar" 
                     [style.width.%]="getProgressPercentage(categoria.estado)">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== FILTROS Y B칔SQUEDA OPTIMIZADOS ====== -->
      <div class="filters-container modern-filters-card mb-4 lg:mb-6">
        <!-- Header de filtros -->
        <div class="filters-header">
          <div class="filters-title-section">
            <h3 class="filters-title">
              <ion-icon name="funnel-outline" class="title-icon"></ion-icon>
              Filtros y B칰squeda
            </h3>
            <div class="filters-stats">
              <span class="results-count">{{ getFacturasFiltradas().length }}</span>
              <span class="results-label">resultados</span>
            </div>
          </div>
          <button *ngIf="categoriaSeleccionada || filtroBusqueda || filtroFechaFin" 
                  (click)="limpiarTodosFiltros()"
                  class="clear-all-btn">
            <ion-icon name="refresh-outline" class="mr-1"></ion-icon>
            Limpiar Todo
          </button>
        </div>

        <!-- Filtros r치pidos por estado -->
        <div class="quick-filters-section">
          <div class="quick-filters-label">
            <ion-icon name="speedometer-outline" class="mr-1"></ion-icon>
            Filtros R치pidos
          </div>
          <div class="quick-filters-grid">
            <button *ngFor="let categoria of categoriasResumen"
                    class="quick-filter-chip"
                    [class.active]="categoriaSeleccionada === categoria.estado"
                    [attr.data-status]="categoria.estado.toLowerCase()"
                    (click)="seleccionarCategoria(categoria.estado)">
              <div class="chip-icon">
                <ion-icon [name]="getIconoEstado(categoria.estado || '')"></ion-icon>
              </div>
              <div class="chip-content">
                <span class="chip-label">{{ categoria.nombre }}</span>
                <span class="chip-count">{{ getResumenCount(categoria.estado) }}</span>
              </div>
            </button>
            
            <!-- Chip especial para "Por Vencer" -->
            <button class="quick-filter-chip special-chip"
                    [class.active]="mostrarPorVencer"
                    (click)="mostrarPorVencer = !mostrarPorVencer; categoriaSeleccionada = null;">
              <div class="chip-icon">
                <ion-icon name="warning-outline"></ion-icon>
              </div>
              <div class="chip-content">
                <span class="chip-label">Por Vencer</span>
                <span class="chip-count">{{ getFacturasPorVencer() }}</span>
              </div>
            </button>
          </div>
        </div>

        <!-- B칰squeda avanzada -->
        <div class="advanced-search-section">
          <div class="search-row">
            <!-- Campo de b칰squeda principal -->
            <div class="search-field-container">
              <div class="search-input-wrapper">
                <div class="search-icon">
                  <ion-icon name="search-outline"></ion-icon>
                </div>
                <input [(ngModel)]="filtroBusqueda" 
                       (ngModelChange)="onBuscarFactura()"
                       placeholder="Buscar por folio, RUT emisor, proveedor..."
                       class="search-input"
                       autocomplete="off" />
                <div class="search-actions">
                  <div *ngIf="buscandoFacturas" class="search-spinner">
                    <ion-spinner name="dots"></ion-spinner>
                  </div>
                  <button *ngIf="filtroBusqueda && !buscandoFacturas" 
                          (click)="filtroBusqueda=''; onBuscarFactura();"
                          class="clear-search-btn">
                    <ion-icon name="close-circle"></ion-icon>
                  </button>
                </div>
              </div>
              
              <!-- Sugerencias mejoradas -->
              <div *ngIf="sugerenciasBusqueda.length > 0 && filtroBusqueda && !buscandoFacturas"
                   class="search-suggestions">
                <div class="suggestions-header">
                  <ion-icon name="bulb-outline" class="mr-1"></ion-icon>
                  Sugerencias
                </div>
                <button *ngFor="let sugerencia of sugerenciasBusqueda; let i = index"
                        (click)="seleccionarSugerencia(sugerencia)"
                        class="suggestion-item"
                        [class.highlighted]="i === 0">
                  <ion-icon name="search-outline" class="suggestion-icon"></ion-icon>
                  <span class="suggestion-text">{{ sugerencia }}</span>
                  <ion-icon name="arrow-forward-outline" class="suggestion-arrow"></ion-icon>
                </button>
              </div>
            </div>

            <!-- Selector de campo de b칰squeda -->
            <div class="search-scope-container">
              <label class="field-label">Buscar en</label>
              <select [(ngModel)]="campoBusqueda" 
                      class="search-scope-select">
                <option value="todos">Todos los campos</option>
                <option value="folio">Solo Folio</option>
                <option value="rut">Solo RUT Emisor</option>
                <option value="proveedor">Solo Proveedor</option>
                <option value="responsable">Solo Responsable</option>
              </select>
            </div>

            <!-- Filtro de fecha de vencimiento -->
            <div class="date-filter-container">
              <label class="field-label">
                <ion-icon name="calendar-outline" class="mr-1"></ion-icon>
                Vencen el d칤a
              </label>
              <input type="date" 
                     [(ngModel)]="filtroFechaFin" 
                     class="date-input" />
            </div>
          </div>

          <!-- Filtros avanzados expandibles -->
          <div class="advanced-filters-toggle">
            <button (click)="mostrarFiltrosAvanzados = !mostrarFiltrosAvanzados"
                    class="toggle-advanced-btn">
              <ion-icon name="options-outline" class="mr-2"></ion-icon>
              Filtros Avanzados
              <ion-icon [name]="mostrarFiltrosAvanzados ? 'chevron-up-outline' : 'chevron-down-outline'" 
                        class="ml-2 toggle-icon"></ion-icon>
            </button>
          </div>

          <!-- Panel de filtros avanzados -->
          <div *ngIf="mostrarFiltrosAvanzados" class="advanced-filters-panel">
            <div class="advanced-filters-grid">
              <!-- Rango de fechas -->
              <div class="filter-group">
                <label class="filter-group-label">
                  <ion-icon name="calendar-number-outline" class="mr-1"></ion-icon>
                  Rango de Fechas de Recepci칩n
                </label>
                <div class="date-range-inputs">
                  <input type="date" 
                         [(ngModel)]="filtroFechaInicio" 
                         placeholder="Desde"
                         class="date-range-input" />
                  <span class="date-range-separator">hasta</span>
                  <input type="date" 
                         [(ngModel)]="filtroFechaFin" 
                         placeholder="Hasta"
                         class="date-range-input" />
                </div>
              </div>

              <!-- Rango de montos -->
              <div class="filter-group">
                <label class="filter-group-label">
                  <ion-icon name="cash-outline" class="mr-1"></ion-icon>
                  Rango de Montos
                </label>
                <div class="amount-range-inputs">
                  <input type="number" 
                         [(ngModel)]="filtroMontoMin" 
                         placeholder="Monto m칤nimo"
                         class="amount-input" />
                  <span class="amount-separator">a</span>
                  <input type="number" 
                         [(ngModel)]="filtroMontoMax" 
                         placeholder="Monto m치ximo"
                         class="amount-input" />
                </div>
              </div>

              <!-- Estados m칰ltiples -->
              <div class="filter-group">
                <label class="filter-group-label">
                  <ion-icon name="flag-outline" class="mr-1"></ion-icon>
                  Estados (selecci칩n m칰ltiple)
                </label>
                <div class="multi-select-chips">
                  <label *ngFor="let categoria of categoriasResumen" 
                         class="multi-select-chip">
                    <input type="checkbox" 
                           [value]="categoria.estado"
                           [(ngModel)]="categoria.selected"
                           class="chip-checkbox" />
                    <span class="chip-checkmark">
                      <ion-icon [name]="getIconoEstado(categoria.estado)" class="mr-1"></ion-icon>
                      {{ categoria.nombre }}
                    </span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Acciones de filtros avanzados -->
            <div class="advanced-filters-actions">
              <button (click)="aplicarFiltrosAvanzados()" 
                      class="apply-filters-btn">
                <ion-icon name="checkmark-outline" class="mr-1"></ion-icon>
                Aplicar Filtros
              </button>
              <button (click)="limpiarFiltrosAvanzados()" 
                      class="clear-filters-btn">
                <ion-icon name="close-outline" class="mr-1"></ion-icon>
                Limpiar
              </button>
            </div>
          </div>
        </div>

        <!-- Filtros activos -->
        <div *ngIf="tienesFiltrosActivos()" class="active-filters-section">
          <div class="active-filters-label">
            <ion-icon name="funnel" class="mr-1"></ion-icon>
            Filtros Activos
          </div>
          <div class="active-filters-list">
            <div *ngIf="categoriaSeleccionada" class="active-filter-tag">
              <span>Estado: {{ categoriaSeleccionada }}</span>
              <button (click)="categoriaSeleccionada = null" class="remove-filter">
                <ion-icon name="close"></ion-icon>
              </button>
            </div>
            <div *ngIf="filtroBusqueda" class="active-filter-tag">
              <span>B칰squeda: "{{ filtroBusqueda }}"</span>
              <button (click)="filtroBusqueda = ''; onBuscarFactura()" class="remove-filter">
                <ion-icon name="close"></ion-icon>
              </button>
            </div>
            <div *ngIf="filtroFechaFin" class="active-filter-tag">
              <span>Vencimiento: {{ filtroFechaFin }}</span>
              <button (click)="filtroFechaFin = ''" class="remove-filter">
                <ion-icon name="close"></ion-icon>
              </button>
            </div>
            <div *ngIf="mostrarPorVencer" class="active-filter-tag">
              <span>Mostrando: Por Vencer</span>
              <button (click)="mostrarPorVencer = false" class="remove-filter">
                <ion-icon name="close"></ion-icon>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== TABLA DE FACTURAS OPTIMIZADA ====== -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-4 lg:p-6">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4">
            <h3 class="text-base lg:text-lg font-semibold text-gray-900">
              Lista de Facturas
              <span class="ml-2 text-sm font-normal text-gray-500">
                ({{ getFacturasFiltradas().length }} encontradas)
              </span>
            </h3>
          </div>
          
          <!-- Tabla mejorada para escritorio - Compacta -->
          <div class="invoice-table-container bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <!-- Header de la tabla con stats -->
            <div class="table-header px-4 lg:px-6 py-3 lg:py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                <div class="flex items-center space-x-3 lg:space-x-4">
                  <h3 class="text-base lg:text-lg font-semibold text-gray-900">Lista de Facturas</h3>
                  <span class="px-2 lg:px-3 py-1 bg-blue-100 text-blue-800 text-xs lg:text-sm font-medium rounded-full">
                    {{ getFacturasFiltradas().length }} facturas
                  </span>
                </div>
                <div class="flex flex-wrap gap-2 lg:space-x-3">
                  <span class="text-xs lg:text-sm text-gray-600">
                    <ion-icon name="time-outline" class="mr-1"></ion-icon>
                    칔ltima actualizaci칩n: {{ getCurrentDateTime() }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Tabla principal -->
            <div class="table-wrapper overflow-x-auto">
              <table class="min-w-full modern-table">
                <thead class="table-head">
                  <tr>
                    <!-- Columnas principales optimizadas -->
                    <th class="table-th sticky-col">
                      <div class="th-content">
                        <ion-icon name="document-text-outline" class="mr-1"></ion-icon>
                        Folio
                      </div>
                    </th>
                    <th class="table-th">
                      <div class="th-content">
                        <ion-icon name="business-outline" class="mr-1"></ion-icon>
                        RUT Emisor
                      </div>
                    </th>
                    <th class="table-th">
                      <div class="th-content">
                        <ion-icon name="calendar-outline" class="mr-1"></ion-icon>
                        Fecha Docto.
                      </div>
                    </th>
                    <th class="table-th">
                      <div class="th-content">
                        <ion-icon name="cash-outline" class="mr-1"></ion-icon>
                        Monto Total
                      </div>
                    </th>
                    <th class="table-th">
                      <div class="th-content">
                        <ion-icon name="calendar-number-outline" class="mr-1"></ion-icon>
                        Fecha Recep.
                      </div>
                    </th>
                    <th class="table-th">
                      <div class="th-content">
                        <ion-icon name="flag-outline" class="mr-1"></ion-icon>
                        Estado
                      </div>
                    </th>
                    <th class="table-th">
                      <div class="th-content">
                        <ion-icon name="hourglass-outline" class="mr-1"></ion-icon>
                        D칤as Rest.
                      </div>
                    </th>
                    <th class="table-th text-center">
                      <div class="th-content">
                        <ion-icon name="settings-outline" class="mr-1"></ion-icon>
                        Acciones
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody class="table-body">
          <tr *ngFor="let factura of getFacturasPaginadas(); trackBy: trackByFolio; let i = index"
            class="table-row cursor-pointer"
            [class.priority-row]="getDiasRestantes(factura) !== null && getDiasRestantes(factura)! <= 2"
            [class.warning-row]="getDiasRestantes(factura) !== null && getDiasRestantes(factura)! > 2 && getDiasRestantes(factura)! <= 5"
            (click)="verFactura(factura)">
                    
                    <!-- Folio (sticky) -->
                    <td class="table-td sticky-col">
                      <div class="flex items-center">
                        <div class="priority-indicator" 
                             *ngIf="getDiasRestantes(factura) !== null && getDiasRestantes(factura)! <= 2">
                        </div>
                        <span class="font-medium text-gray-900">
                          {{ getValorFactura(factura, 'Folio') || getValorFactura(factura, 'Nro.') || 'N/A' }}
                        </span>
                      </div>
                    </td>
                    
                    <!-- RUT Emisor -->
                    <td class="table-td">
                      <span class="text-gray-700 font-mono text-sm">
                        {{ getValorFactura(factura, 'RUT Emisor') || 'N/A' }}
                      </span>
                    </td>
                    
                    <!-- Fecha Documento -->
                    <td class="table-td">
                      <span class="text-gray-600">
                        {{ getValorFactura(factura, 'Fecha Docto.') || 'N/A' }}
                      </span>
                    </td>
                    
                    <!-- Monto Total -->
                    <td class="table-td">
                      <span class="font-semibold text-gray-900 currency">
                        {{ getValorFactura(factura, 'Monto Total') | currency:'CLP':'symbol-narrow':'1.0-0' }}
                      </span>
                    </td>
                    
                    <!-- Fecha Recepci칩n -->
                    <td class="table-td">
                      <span class="text-gray-600">
                        {{ getValorFactura(factura, 'Fecha Recep.') || 'N/A' }}
                      </span>
                    </td>
                    
                    <!-- Estado mejorado -->
                    <td class="table-td">
                      <div class="status-badge" [attr.data-status]="(factura.estado || '').toLowerCase()">
                        <ion-icon [name]="getIconoEstado(factura.estado)" class="status-icon"></ion-icon>
                        <span class="status-text">{{ factura.estado || 'Pendiente' }}</span>
                      </div>
                    </td>
                    
                    <!-- D칤as restantes mejorado -->
                    <td class="table-td">
                      <div class="days-remaining" *ngIf="getDiasRestantes(factura) !== null"
                           [attr.data-urgency]="getDiasRestantes(factura)! <= 2 ? 'critical' : getDiasRestantes(factura)! <= 5 ? 'warning' : 'normal'">
                        <span class="days-number">{{ getDiasRestantes(factura) }}</span>
                        <span class="days-label">d칤as</span>
                      </div>
                      <span *ngIf="getDiasRestantes(factura) === null" class="text-gray-400 text-sm">
                        N/A
                      </span>
                    </td>
                    
                    <!-- Acciones mejoradas -->
                    <td class="table-td text-center">
                      <div class="action-buttons">
                        <button (click)="verFactura(factura)"
                                class="action-btn action-btn-primary"
                                title="Ver detalles">
                          <ion-icon name="eye-outline"></ion-icon>
                        </button>
                        <button *ngIf="getFacturaFileUrl(factura)"
                                (click)="descargarArchivo(factura)"
                                class="action-btn action-btn-secondary"
                                title="Descargar archivo">
                          <ion-icon name="download-outline"></ion-icon>
                        </button>
                      </div>
                    </td>
                  </tr>
                  
                  <!-- Estado vac칤o mejorado -->
                  <tr *ngIf="getFacturasFiltradas().length === 0" class="empty-state-row">
                    <td [attr.colspan]="8" class="empty-state">
                      <div class="empty-state-content">
                        <div class="empty-state-icon">
                          <ion-icon name="document-outline"></ion-icon>
                        </div>
                        <h3 class="empty-state-title">No se encontraron facturas</h3>
                        <p class="empty-state-description">
                          <span *ngIf="!facturas.length">Importa un archivo CSV para comenzar</span>
                          <span *ngIf="facturas.length">Intenta ajustar los filtros de b칰squeda</span>
                        </p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- ====== PAGINACI칍N ====== -->
            <div class="pagination-container flex flex-col sm:flex-row items-center justify-between gap-4 p-4 lg:p-6 border-t border-gray-200 bg-gray-50">
              <!-- Informaci칩n de paginaci칩n -->
              <div class="pagination-info text-sm text-gray-600">
                <span class="font-medium">
                  Mostrando {{ getPaginacionInfo().inicio }} - {{ getPaginacionInfo().fin }} 
                  de {{ getFacturasFiltradas().length }} facturas
                </span>
              </div>
              
              <!-- Controles de paginaci칩n -->
              <div class="pagination-controls flex items-center gap-2">
                <!-- Selector de elementos por p치gina -->
                <div class="items-per-page flex items-center gap-2 mr-4">
                  <label class="text-sm text-gray-600">Mostrar:</label>
                  <select [(ngModel)]="elementosPorPagina" 
                          (ngModelChange)="cambiarElementosPorPagina()"
                          class="border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                </div>
                
                <!-- Botones de navegaci칩n -->
                <button (click)="irAPrimeraPagina()" 
                        [disabled]="paginaActual === 1"
                        class="pagination-btn text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                  <ion-icon name="chevron-back-outline" class="mr-1"></ion-icon>
                  Primera
                </button>
                
                <button (click)="irAPaginaAnterior()" 
                        [disabled]="paginaActual === 1"
                        class="pagination-btn text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                  <ion-icon name="chevron-back-outline"></ion-icon>
                </button>
                
                <!-- N칰meros de p치gina -->
                <div class="page-numbers flex items-center gap-1">
                  <button *ngFor="let page of getPaginasVisibles()" 
                          (click)="irAPagina(page)"
                          [class.active]="page === paginaActual"
                          class="page-number-btn w-8 h-8 text-sm rounded-md border border-gray-300 hover:bg-gray-50"
                          [class.bg-blue-500]="page === paginaActual"
                          [class.text-white]="page === paginaActual"
                          [class.border-blue-500]="page === paginaActual">
                    {{ page }}
                  </button>
                </div>
                
                <button (click)="irAPaginaSiguiente()" 
                        [disabled]="paginaActual >= getTotalPaginas()"
                        class="pagination-btn text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                  <ion-icon name="chevron-forward-outline"></ion-icon>
                </button>
                
                <button (click)="irAUltimaPagina()" 
                        [disabled]="paginaActual >= getTotalPaginas()"
                        class="pagination-btn text-sm px-3 py-1 rounded-md border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                  칔ltima
                  <ion-icon name="chevron-forward-outline" class="ml-1"></ion-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== SECCI칍N DE ASISTENTE IA ====== -->
      <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl shadow-sm border border-blue-200 mt-6">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                <ion-icon name="sparkles-outline" class="text-white text-xl"></ion-icon>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">游뱄 Asistente de IA</h3>
                <p class="text-sm text-gray-600">Procesa facturas autom치ticamente con inteligencia artificial</p>
              </div>
            </div>
            <button 
              (click)="activarAsistenteIA()"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
              <ion-icon name="flash-outline"></ion-icon>
              <span>Activar IA</span>
            </button>
          </div>

          <!-- Panel expandible de funciones IA -->
          <div *ngIf="mostrarPanelIA" class="mt-4 space-y-4 animate-fade-in">
            <!-- Simulador de carga de archivo -->
            <div class="bg-white rounded-lg p-4 border border-blue-200">
              <h4 class="font-medium text-gray-900 mb-3 flex items-center">
                <ion-icon name="camera-outline" class="mr-2 text-blue-500"></ion-icon>
                Cargar Factura para Procesamiento
              </h4>
              <div class="flex items-center space-x-3">
                <input 
                  type="file" 
                  (change)="manejarArchivoIA($event)" 
                  accept="image/*,.pdf"
                  class="flex-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button 
                  (click)="procesarFacturaConIA()"
                  [disabled]="!archivoIA"
                  class="bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                  <ion-icon name="cog-outline"></ion-icon>
                  <span>Procesar</span>
                </button>
              </div>
            </div>

            <!-- Vista previa de resultados IA -->
            <div *ngIf="mostrandoPreviewIA" class="bg-white rounded-lg p-4 border border-green-200">
              <h4 class="font-medium text-gray-900 mb-3 flex items-center">
                <ion-icon name="checkmark-circle-outline" class="mr-2 text-green-500"></ion-icon>
                Resultados del Procesamiento
              </h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4" *ngIf="datosExtraidosIA">
                <!-- Datos extra칤dos -->
                <div class="space-y-3">
                  <h5 class="font-medium text-gray-700 border-b pb-1">游늯 Datos Extra칤dos</h5>
                  <div class="text-sm space-y-1">
                    <p><span class="font-medium">Folio:</span> {{ datosExtraidosIA.folio }}</p>
                    <p><span class="font-medium">RUT:</span> {{ datosExtraidosIA.rutEmisor }}</p>
                    <p><span class="font-medium">Raz칩n Social:</span> {{ datosExtraidosIA.razonSocial }}</p>
                    <p><span class="font-medium">Fecha:</span> {{ datosExtraidosIA.fechaEmision }}</p>
                    <p><span class="font-medium">Monto:</span> ${{ datosExtraidosIA.montoTotal | number:'1.0-0' }}</p>
                  </div>
                </div>

                <!-- An치lisis IA -->
                <div class="space-y-3">
                  <h5 class="font-medium text-gray-700 border-b pb-1">游댌 An치lisis IA</h5>
                  <div class="text-sm space-y-1" *ngIf="categoriaIA">
                    <p><span class="font-medium">Categor칤a:</span> {{ categoriaIA.categoria }}</p>
                    <p><span class="font-medium">Confianza:</span> {{ (categoriaIA.confianza * 100) | number:'1.1-1' }}%</p>
                    <p><span class="font-medium">Prioridad:</span> {{ categoriaIA.prioridad }}</p>
                  </div>
                  <div class="text-sm" *ngIf="verificacionDuplicado">
                    <p [ngClass]="{'text-red-600': verificacionDuplicado.esDuplicado, 'text-green-600': !verificacionDuplicado.esDuplicado}">
                      <span class="font-medium">Duplicado:</span> 
                      {{ verificacionDuplicado.esDuplicado ? 'S칤 detectado' : 'No detectado' }}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Botones de acci칩n -->
              <div class="flex justify-end space-x-3 mt-4 pt-4 border-t">
                <button 
                  (click)="editarDatosIA(datosExtraidosIA!, categoriaIA!)"
                  class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                  <ion-icon name="create-outline"></ion-icon>
                  <span>Editar</span>
                </button>
                <button 
                  (click)="guardarFacturaIA(datosExtraidosIA!, categoriaIA!)"
                  class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                  <ion-icon name="save-outline"></ion-icon>
                  <span>Guardar</span>
                </button>
              </div>
            </div>

            <!-- Estad칤sticas de IA -->
            <div class="bg-white rounded-lg p-4 border border-purple-200">
              <h4 class="font-medium text-gray-900 mb-3 flex items-center">
                <ion-icon name="analytics-outline" class="mr-2 text-purple-500"></ion-icon>
                Estad칤sticas del Asistente
              </h4>
              <div class="grid grid-cols-3 gap-4 text-center">
                <div class="bg-blue-50 rounded-lg p-3">
                  <div class="text-2xl font-bold text-blue-600">{{ estadisticasIA.facturasProcesadas || 0 }}</div>
                  <div class="text-xs text-gray-600">Procesadas</div>
                </div>
                <div class="bg-green-50 rounded-lg p-3">
                  <div class="text-2xl font-bold text-green-600">{{ estadisticasIA.precision || 95 }}%</div>
                  <div class="text-xs text-gray-600">Precisi칩n</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-3">
                  <div class="text-2xl font-bold text-purple-600">{{ estadisticasIA.duplicadosDetectados || 0 }}</div>
                  <div class="text-xs text-gray-600">Duplicados</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</ion-content>