<app-header 
  title="Dashboard" 
  titleIcon="analytics-outline"
  shadowClass="shadow-lg"
  [endButtons]="[{icon: 'refresh-outline', action: 'refresh', iconOnly: true}]"
  (buttonClick)="onHeaderButtonClick($event)">
</app-header>

<ion-content [fullscreen]="true" class="dashboard-content">
  <!-- Hero Section with Gradient -->
  <div class="hero-section bg-gradient-to-br from-blue-800 via-blue-700 to-blue-600 relative overflow-hidden"
       style="background: linear-gradient(135deg, #19417C 0%, #2563eb 50%, #1e40af 100%);">
    <div class="absolute inset-0 bg-black opacity-10"></div>
    <div class="relative max-w-7xl mx-auto px-6 py-12">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-white mb-2">Dashboard Ejecutivo</h1>
        <p class="text-blue-100 text-lg">Panel de control y métricas principales</p>
      </div>
      
      <!-- KPI Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
        <!-- Facturas por vencer hoy -->
        <div class="kpi-card bg-white/90 backdrop-blur-sm rounded-xl p-6 shadow-lg border border-white/20">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Por Vencer Hoy</p>
              <p class="text-3xl font-bold text-red-600">{{ getFacturasPorVencerHoy().length }}</p>
              <p class="text-xs text-gray-500">facturas críticas</p>
            </div>
            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
              <ion-icon name="alarm-outline" class="text-xl text-red-600"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Total facturas -->
        <div class="kpi-card bg-white/90 backdrop-blur-sm rounded-xl p-6 shadow-lg border border-white/20">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Facturas</p>
              <p class="text-3xl font-bold text-blue-600">{{ facturas.length }}</p>
              <p class="text-xs text-gray-500">en sistema</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
              <ion-icon name="document-text-outline" class="text-xl text-blue-600"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Monto total -->
        <div class="kpi-card bg-white/90 backdrop-blur-sm rounded-xl p-6 shadow-lg border border-white/20">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Monto Total</p>
              <p class="text-3xl font-bold text-green-600">{{ getMontoTotalFacturacion() | currency:'USD' }}</p>
              <p class="text-xs text-gray-500">valor acumulado</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
              <ion-icon name="cash-outline" class="text-xl text-green-600"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Próximos 7 días -->
        <div class="kpi-card bg-white/90 backdrop-blur-sm rounded-xl p-6 shadow-lg border border-white/20">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Próximos 7 Días</p>
              <p class="text-3xl font-bold text-orange-600">{{ getFacturasPorVencerCount() }}</p>
              <p class="text-xs text-gray-500">por vencer</p>
            </div>
            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
              <ion-icon name="calendar-outline" class="text-xl text-orange-600"></ion-icon>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="main-content max-w-7xl mx-auto px-6 py-8">
    <!-- Gráfico de distribución - Full width para mejor visualización -->
    <div class="mb-8">
      <ion-card class="chart-card rounded-xl shadow-sm border-0">
        <ion-card-header>
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <ion-icon name="pie-chart-outline" class="text-lg text-purple-600"></ion-icon>
              </div>
              <div>
                <ion-card-title class="text-xl font-semibold">Distribución por Proveedor</ion-card-title>
                <p class="text-sm text-gray-600">Montos facturados y detalles de proveedores</p>
              </div>
            </div>
            <div class="flex space-x-2">
              <ion-button fill="clear" size="small" color="medium" (click)="toggleMostrarRuts()">
                <ion-icon name="list-outline" slot="start"></ion-icon>
                {{ mostrarDetallesRuts ? 'Ocultar' : 'Ver' }} RUTs
              </ion-button>
              <ion-button fill="clear" size="small" color="medium" (click)="toggleVisualizacion()">
                <ion-icon [name]="vistaDetallada ? 'contract-outline' : 'expand-outline'" slot="start"></ion-icon>
                {{ vistaDetallada ? 'Simplificar' : 'Detallar' }}
              </ion-button>
              <ion-button fill="clear" size="small" color="medium" (click)="generarGraficoTorta()">
                <ion-icon name="refresh-outline"></ion-icon>
              </ion-button>
            </div>
          </div>
        </ion-card-header>
        <ion-card-content class="p-6">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Gráfico principal - más espacio -->
            <div [class]="vistaDetallada ? 'lg:col-span-2' : 'lg:col-span-3'">
              <div class="chart-container" [style.height]="vistaDetallada ? '450px' : '500px'">
                <canvas #pieChartCanvas></canvas>
                @if (!pieChart) {
                  <div class="absolute inset-0 flex items-center justify-center text-gray-500">
                    <div class="text-center">
                      <ion-icon name="pie-chart-outline" class="text-4xl mb-2"></ion-icon>
                      <p>Generando gráfico...</p>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Panel de estadísticas rápidas -->
            @if (vistaDetallada) {
              <div class="lg:col-span-1">
                <div class="space-y-4">
                  <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border">
                    <h4 class="font-semibold text-gray-800 mb-2">Resumen</h4>
                    <div class="space-y-2 text-sm">
                      <div class="flex justify-between">
                        <span class="text-gray-600">Total Proveedores:</span>
                        <span class="font-medium">{{ proveedores.length }}</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-gray-600">Monto Total:</span>
                        <span class="font-medium">{{ getMontoTotalFacturacion() | currency:'USD' }}</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-gray-600">Promedio por Proveedor:</span>
                        <span class="font-medium">{{ getPromedioMontoProveedor() | currency:'USD' }}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Top 3 Proveedores -->
                  <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg border">
                    <h4 class="font-semibold text-gray-800 mb-2">Top 3 Proveedores</h4>
                    <div class="space-y-2">
                      @for (item of getTopProveedores().slice(0, 3); track item.proveedor; let i = $index) {
                        <div class="flex items-center justify-between text-sm">
                          <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold"
                                 [class]="i === 0 ? 'bg-yellow-500 text-white' : 
                                         i === 1 ? 'bg-gray-400 text-white' : 
                                         'bg-orange-500 text-white'">
                              {{ i + 1 }}
                            </div>
                            <span class="font-medium truncate max-w-[120px]" [title]="item.proveedor">
                              {{ item.proveedor.length > 15 ? item.proveedor.substring(0, 15) + '...' : item.proveedor }}
                            </span>
                          </div>
                          <span class="font-semibold text-green-600">{{ item.monto | currency:'USD':'symbol':'1.0-0' }}</span>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Tabla de detalles de proveedores con RUTs -->
    @if (mostrarDetallesRuts) {
      <div class="mb-8">
        <ion-card class="table-card rounded-xl shadow-sm border-0">
          <ion-card-header>
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                  <ion-icon name="business-outline" class="text-lg text-indigo-600"></ion-icon>
                </div>
                <div>
                  <ion-card-title class="text-xl font-semibold">Detalles de Proveedores</ion-card-title>
                  <p class="text-sm text-gray-600">RUTs, montos y cantidad de facturas por proveedor</p>
                </div>
              </div>
              <div class="flex space-x-2">
                <ion-button fill="clear" size="small" color="medium" (click)="filtrarProveedores()">
                  <ion-icon name="funnel-outline" slot="start"></ion-icon>
                  Filtrar
                </ion-button>
                <ion-button fill="clear" size="small" color="medium" (click)="exportarProveedores()">
                  <ion-icon name="download-outline" slot="start"></ion-icon>
                  Exportar
                </ion-button>
              </div>
            </div>
          </ion-card-header>
          <ion-card-content class="p-0">
            <div class="overflow-x-auto">
              <table class="w-full table-auto">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      Ranking
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" (click)="ordenarPor('proveedor')">
                      Proveedor
                      <ion-icon name="swap-vertical-outline" class="ml-1 text-xs"></ion-icon>
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      RUT
                    </th>
                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" (click)="ordenarPor('monto')">
                      Monto Total
                      <ion-icon name="swap-vertical-outline" class="ml-1 text-xs"></ion-icon>
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" (click)="ordenarPor('cantidad')">
                      Facturas
                      <ion-icon name="swap-vertical-outline" class="ml-1 text-xs"></ion-icon>
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      % del Total
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  @for (proveedor of getProveedoresDetallados(); track proveedor.nombre; let i = $index) {
                    <tr class="hover:bg-gray-50 transition-colors duration-150" [class]="i < 3 ? 'border-l-4 border-l-green-400' : ''">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                          <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                               [class]="i === 0 ? 'bg-yellow-500 text-white' : 
                                       i === 1 ? 'bg-gray-400 text-white' : 
                                       i === 2 ? 'bg-orange-500 text-white' : 
                                       'bg-blue-100 text-blue-600'">
                            {{ i + 1 }}
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                          <p class="font-medium text-gray-900" [title]="proveedor.nombre">{{ proveedor.nombre }}</p>
                          <p class="text-xs text-gray-500">{{ proveedor.cantidad }} facturas</p>
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-mono bg-gray-100 px-2 py-1 rounded text-gray-800">
                          {{ proveedor.rut || 'No disponible' }}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-right">
                        <span class="font-semibold text-lg text-gray-900">{{ proveedor.monto | currency:'USD' }}</span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800">
                          {{ proveedor.cantidad }}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex flex-col items-center">
                          <span class="text-sm font-medium">{{ proveedor.porcentaje }}%</span>
                          <div class="w-16 bg-gray-200 rounded-full h-2 mt-1">
                            <div class="bg-blue-600 h-2 rounded-full" [style.width.%]="proveedor.porcentaje"></div>
                          </div>
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center space-x-2">
                          <ion-button fill="clear" size="small" color="primary" (click)="verDetalleProveedor(proveedor)">
                            <ion-icon name="eye-outline"></ion-icon>
                          </ion-button>
                          <ion-button fill="clear" size="small" color="medium" (click)="filtrarPorProveedor(proveedor)">
                            <ion-icon name="filter-outline"></ion-icon>
                          </ion-button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    }

    <!-- Grid para ranking y facturas críticas -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
      <!-- Ranking de proveedores - Ahora más compacto -->
      <div>
        <ion-card class="ranking-card rounded-xl shadow-sm border-0">
          <ion-card-header>
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                <ion-icon name="trophy-outline" class="text-lg text-indigo-600"></ion-icon>
              </div>
              <div>
                <ion-card-title class="text-lg font-semibold">Top Proveedores</ion-card-title>
                <p class="text-sm text-gray-600">Facturas por vencer hoy</p>
              </div>
            </div>
          </ion-card-header>
          <ion-card-content class="p-6">
            <div class="space-y-4">
              @for (item of getRankingProveedoresPorVencerHoy().slice(0, 5); track item.proveedor; let i = $index) {
                <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                  <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"
                         [class]="i === 0 ? 'bg-yellow-500 text-white' : 
                                 i === 1 ? 'bg-gray-400 text-white' : 
                                 i === 2 ? 'bg-orange-500 text-white' : 
                                 'bg-blue-100 text-blue-600'">
                      {{ i + 1 }}
                    </div>
                    <div>
                      <p class="font-medium text-sm">{{ item.proveedor }}</p>
                      <p class="text-xs text-gray-500">{{ item.cantidad }} facturas</p>
                    </div>
                  </div>
                  <div class="w-2 h-8 rounded-full"
                       [class]="i === 0 ? 'bg-yellow-500' : 
                               i === 1 ? 'bg-gray-400' : 
                               i === 2 ? 'bg-orange-500' : 
                               'bg-blue-300'">
                  </div>
                </div>
              }
              
              @if (getRankingProveedoresPorVencerHoy().length === 0) {
                <div class="text-center py-8 text-gray-500">
                  <ion-icon name="checkmark-circle-outline" class="text-4xl mb-2"></ion-icon>
                  <p class="text-sm">No hay facturas por vencer hoy</p>
                </div>
              }
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      </div>

    <!-- Grid secundario -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mt-8">
      <!-- Facturas críticas - Expandido a 2 columnas -->
      <div class="xl:col-span-2">
        <ion-card class="table-card rounded-xl shadow-sm border-0">
          <ion-card-header>
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                  <ion-icon name="alert-circle-outline" class="text-lg text-red-600"></ion-icon>
                </div>
                <div>
                  <ion-card-title class="text-xl font-semibold">Facturas por Vencer Mañana</ion-card-title>
                  <p class="text-sm text-gray-600">Facturas no revisadas que requieren atención</p>
                </div>
              </div>
              <div class="flex space-x-2">
                <ion-button fill="clear" size="small" color="medium">
                  <ion-icon name="filter-outline" slot="start"></ion-icon>
                  Filtrar
                </ion-button>
                <ion-button fill="clear" size="small" color="primary" routerLink="/invoices">
                  <ion-icon name="eye-outline" slot="start"></ion-icon>
                  Ver Todas
                </ion-button>
              </div>
            </div>
          </ion-card-header>
          <ion-card-content class="p-0">
            <div class="overflow-x-auto">
              <table class="w-full table-auto">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      Folio
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      Proveedor
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      RUT
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      Fecha
                    </th>
                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      Monto
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      Estado
                    </th>
                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  @for (f of getFacturasPorVencerManianaNoRevisadas(); track f.folio || f.numero || $index) {
                    <tr class="hover:bg-gray-50 transition-colors duration-150 border-l-4 border-l-orange-400">
                      <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                          <div class="w-2 h-2 bg-orange-400 rounded-full"></div>
                          <span class="font-medium text-gray-900">{{ f.folio || f.numero || '-' }}</span>
                        </div>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <p class="font-medium text-gray-900">{{ f.proveedor || f.nombreProveedor || f.razonSocial || 'Sin proveedor' }}</p>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-mono bg-gray-100 px-2 py-1 rounded text-gray-800">{{ getRutFromFactura(f) }}</span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-gray-600">{{ f.fechaRecepcion || f.fecha || f.fecha_recepcion || '-' }}</span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-right">
                        <span class="font-semibold text-lg text-gray-900">{{ (f['Monto Total'] || f.monto || f.total || 0) | currency:'USD' }}</span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-800">
                          {{ f.estado || 'Pendiente' }}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center space-x-2">
                          <ion-button fill="clear" size="small" color="primary">
                            <ion-icon name="eye-outline"></ion-icon>
                          </ion-button>
                          <ion-button fill="clear" size="small" color="success">
                            <ion-icon name="checkmark-outline"></ion-icon>
                          </ion-button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
              
              <!-- Estado vacío -->
              @if (getFacturasPorVencerManianaNoRevisadas().length === 0) {
                <div class="text-center py-12">
                  <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <ion-icon name="checkmark-circle-outline" class="text-3xl text-green-600"></ion-icon>
                  </div>
                  <h3 class="text-lg font-semibold text-gray-800 mb-2">¡Excelente trabajo!</h3>
                  <p class="text-gray-600">No hay facturas por vencer mañana que requieran revisión</p>
                </div>
              }
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>

    <!-- Alerta de facturas por vencer -->
    @if (showAlertaPorVencer) {
      <div class="mt-8">
        <ion-card class="alert-card bg-gradient-to-r from-red-50 to-orange-50 border-l-4 border-l-red-500">
          <ion-card-content class="p-6">
            <div class="flex items-center space-x-4">
              <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <ion-icon name="warning-outline" class="text-2xl text-red-600"></ion-icon>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-red-800 mb-1">Atención Requerida</h3>
                <p class="text-red-700">{{ getAlertaPorVencerHoy() }}</p>
              </div>
              <ion-button fill="solid" color="danger" routerLink="/invoices">
                <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
                Revisar Facturas
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    }
  </div>  <!-- Footer spacing -->
  <div class="h-8"></div>
</ion-content>